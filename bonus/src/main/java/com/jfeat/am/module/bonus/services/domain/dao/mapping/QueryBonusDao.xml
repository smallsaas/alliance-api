<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.am.module.bonus.services.domain.dao.QueryBonusDao">
    <select id="getAllianceBonus" resultType="java.math.BigDecimal">
        select sum((oi.quantity*(p.price-p.cost_price))*JSON_EXTRACT(b.proportion,'$.value')/(100.0))
        from t_order o,t_order_item oi ,t_product p,t_product_settlement_proportion b
        where
        o.created_date > STR_TO_DATE((select value from t_config_field where field='starting_time'),'%Y-%m-%d')
        and o.status='CLOSED_CONFIRMED' and o.user_id=#{userId} and p.id=oi.product_id and b.product_id=p.id
        and b.type='STOCKHOLDER'
        <choose>
            <when test="dateType=='1'">
                and to_days(o.created_date)=to_days(now())
            </when>
            <when test="dateType=='2'">
                and date_format(o.created_date, '%Y%m' ) = date_format( curdate() , '%Y%m' )
            </when>
            <when test="dateType=='3'">
                and quarter(o.created_date)=quarter(now())
            </when>
            <when test="dateType=='4'">
                and date_format(o.created_date, '%Y %m') = date_format(DATE_SUB(curdate(), INTERVAL 1 MONTH),'%Y %m')
            </when>
        </choose>
    </select>


    <!--给别人的提成-->
    <select id="getTeamBonus" resultType="java.math.BigDecimal">
        select sum((oi.quantity*(p.price-p.cost_price))*JSON_EXTRACT(b.proportion,'$.value')/(100.0))
        from t_order o,t_order_item oi ,t_product p,t_product_settlement_proportion b
        where
        o.status='CLOSED_CONFIRMED' and o.user_id=#{userId} and p.id=oi.product_id and b.product_id=p.id
        and b.type='ALLIANCE'
        <choose>
            <!--当天-->
            <when test="dateType=='1'">
                and to_days(o.created_date)=to_days(now())
            </when>
            <!--当月-->
            <when test="dateType=='2'">
                and date_format(o.created_date, '%Y%m' ) = date_format( curdate() , '%Y%m' )
            </when>
            <!--当季度-->
            <when test="dateType=='3'">
                and quarter(o.created_date)=quarter(now())
            </when>
            <!--上个月-->
            <when test="dateType=='4'">
                and date_format(o.created_date, '%Y %m') = date_format(DATE_SUB(curdate(), INTERVAL 1 MONTH),'%Y %m')
            </when>
        </choose>


    </select>

    <select id="queryAllianceExist" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select count(id) from t_alliance where user_id=#{userId}
    </select>

    <select id="querySales" resultType="com.jfeat.am.module.bonus.services.domain.model.ProductSalesRecord">
        <bind name="off_set" value="(pageNum-1)*pageSize"/>
        select p.id,p.name,p.cover,oitem.quantity as quantity ,pc.name as category, p.unit as
        unit,p.price*oitem.quantity as sales
        from t_product p LEFT JOIN (select o.id as
        order_id,oi.product_id,oi.quantity from t_order o,t_order_item oi where oi.order_id=o.id and
        o.status='CLOSED_CONFIRMED' and o.created_date
        between (select STR_TO_DATE(VALUE,'%Y-%m-%d') from t_config_field where field='starting_time') and
        DATE_ADD((select STR_TO_DATE(VALUE,'%Y-%m-%d') from t_config_field where field='starting_time')
        ,INTERVAL (select value from t_config_field where field='settlement_cycle' ) MONTH)
        ) as oitem ON p.id=oitem.product_id LEFT JOIN t_product_category pc on p.category_id=pc.id

        <if test="search != null and search != ''">
            where
            p.name LIKE CONCAT('%',#{search},'%')
            OR pc.name LIKE CONCAT('%',#{search},'%')
        </if>

        GROUP BY p.id ORDER
        BY oitem.quantity desc limit #{off_set},#{pageSize}
    </select>

    <select id="queryReInformation" resultType="com.jfeat.am.module.bonus.services.domain.model.AllianceReconciliation">
        select a.alliance_type as allianceType,a.id,a.alliance_name as allianceName,a.user_id as userId ,
        count(children.id)+1 as teamCount from
        t_alliance a
        left JOIN t_alliance children on a.id=children.invitor_alliance_id where a.alliance_ship=0

        <if test="search != null and search != ''">
            and a.alliance_name LIKE CONCAT('%',#{search},'%')
        </if>
        group by a.id
    </select>

    <select id="queryBonusOrder" resultType="java.math.BigDecimal" parameterType="java.lang.Long">
        select sum(p.price*oi.quantity) from t_alliance a,t_order o,t_order_item oi,t_product p where a.user_id=#{userId} and o.user_id=a.user_id
AND
oi.order_id=o.id and p.id=oi.product_id and a.alliance_ship=0 and  date_format(o.created_date, '%Y%m' ) = date_format( curdate() , '%Y%m' )
    </select>

    <select id="queryAllianceName" resultType="string" parameterType="java.lang.Long">
        select alliance_name from t_alliance where user_id=#{userId}
    </select>

    <select id="queryShip" resultType="Integer" parameterType="java.lang.Long">
        select alliance_ship from t_alliance where user_id=#{userId}
    </select>

    <select id="queryType" resultType="Integer" parameterType="java.lang.Long">
        select alliance_type from t_alliance where user_id=#{userId}
    </select>

    <select id="getCommissionOrder" parameterType="java.lang.Long" resultType="com.alibaba.fastjson.JSONObject">
select u.name as invitorName,FORMAT((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100,2) as commission,o.total_price orderMoney from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id LEFT JOIN t_user u on u.id=o.user_id
LEFT JOIN t_alliance a on a.user_id = #{userId}
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='ALLIANCE'
LEFT JOIN t_alliance kid on kid.invitor_alliance_id=a.id and kid.user_id=u.id  where o.`status`='CLOSED_CONFIRMED' and kid.user_id!=a.user_id
    </select>

    <select id="getCommissionOrderMonth" parameterType="java.lang.Long" resultType="com.alibaba.fastjson.JSONObject">
select u.name as invitorName,FORMAT((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100,2) as commission,o.total_price orderMoney from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id LEFT JOIN t_user u on u.id=o.user_id
LEFT JOIN t_alliance a on a.user_id = #{userId}
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='ALLIANCE'
LEFT JOIN t_alliance kid on kid.invitor_alliance_id=a.id and kid.user_id=u.id  where o.`status`='CLOSED_CONFIRMED' and kid.user_id!=a.user_id and month(o.created_date) = month(curdate()) and year(o.created_date) = year(curdate())
    </select>
    <select id="getCommissionOrderLastMonth" parameterType="java.lang.Long"
            resultType="com.alibaba.fastjson.JSONObject">
select u.name as invitorName,FORMAT((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100,2) as commission,o.total_price orderMoney from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id LEFT JOIN t_user u on u.id=o.user_id
LEFT JOIN t_alliance a on a.user_id = #{userId}
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='ALLIANCE'
LEFT JOIN t_alliance kid on kid.invitor_alliance_id=a.id and kid.user_id=u.id  where o.`status`='CLOSED_CONFIRMED' and kid.user_id!=a.user_id
and month(o.created_date) =
month(DATE_SUB(CURDATE(), INTERVAL 1 MONTH)) month(curdate()) and year(o.created_date) = year(curdate())
    </select>
    <select id="getCommissionTotal" parameterType="java.lang.Long" resultType="java.math.BigDecimal">
select FORMAT(sum(((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100),2),o.total_price orderMoney from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id LEFT JOIN t_user u on u.id=o.user_id
LEFT JOIN t_alliance a on a.user_id = #{userId}
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='ALLIANCE'
LEFT JOIN t_alliance kid on kid.invitor_alliance_id=a.id and kid.user_id=u.id  where o.`status`='CLOSED_CONFIRMED' and kid.user_id!=a.user_id
    </select>
    <select id="getCommissionTotalMonth" parameterType="java.lang.Long" resultType="java.math.BigDecimal">
select FORMAT(sum(((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100),2),o.total_price orderMoney from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id LEFT JOIN t_user u on u.id=o.user_id
LEFT JOIN t_alliance a on a.user_id = #{userId}
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='ALLIANCE'
LEFT JOIN t_alliance kid on kid.invitor_alliance_id=a.id and kid.user_id=u.id  where o.`status`='CLOSED_CONFIRMED' and kid.user_id!=a.user_id
    and month(o.created_date) = month(curdate()) and year(o.created_date) = year(curdate())
    </select>

    <select id="getCommissionOrderTotalLastMonth" parameterType="java.lang.Long" resultType="java.math.BigDecimal">
select FORMAT(sum(((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100),2),o.total_price orderMoney from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id LEFT JOIN t_user u on u.id=o.user_id
LEFT JOIN t_alliance a on a.user_id = #{userId}
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='ALLIANCE'
LEFT JOIN t_alliance kid on kid.invitor_alliance_id=a.id and kid.user_id=u.id  where o.`status`='CLOSED_CONFIRMED' and kid.user_id!=a.user_id
    and month(o.created_date) =
month(DATE_SUB(CURDATE(), INTERVAL 1 MONTH)) month(curdate()) and year(o.created_date) = year(curdate())
    </select>

    <select id="getAllBonusReal" resultType="java.math.BigDecimal">
        select FORMAT(sum((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100.0),2) from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id and o.created_date>STR_TO_DATE((select value from t_config_field where field='starting_time'),'%Y-%m-%d') and o.status='CLOSED_CONFIRMED'
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='STOCKHOLDER'
    </select>

    <select id="getAllBonusReal" resultType="java.math.BigDecimal">
        select FORMAT(sum((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100.0),2) from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id and o.created_date>STR_TO_DATE((select value from t_config_field where field='starting_time'),'%Y-%m-%d') and o.status='CLOSED_CONFIRMED'
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='STOCKHOLDER'
    </select>
    
    <select id="getAverageBonus" resultType="java.math.BigDecimal">
        select sum((item.price-item.cost_price)*item.quantity*JSON_EXTRACT(psp.proportion,'$.value')/100.0)/(select count(id) from t_alliance where alliance_type=2 and alliance_ship=0) from t_order_item item
LEFT JOIN t_order o on item.order_id=o.id and o.created_date>STR_TO_DATE((select value from t_config_field where field='starting_time'),'%Y-%m-%d') and o.status='CLOSED_CONFIRMED'
LEFT JOIN t_product_settlement_proportion psp on psp.product_id=item.product_id and psp.type='STOCKHOLDER'
    </select>
</mapper>